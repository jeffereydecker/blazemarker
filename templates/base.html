<!doctype html>
<html lang="en">

<head>
<meta charset="utf-8">
<meta name="description" content="Fun for family and friends">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Blazemarker</title>

<!-- PWA Meta Tags -->
<meta name="theme-color" content="#667eea">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Blazemarker">
<link rel="manifest" href="/static/manifest.json">

<!-- Favicons -->
<link rel="icon" href="/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="192x192" href="/android-chrome-192x192.png">
<link rel="icon" type="image/png" sizes="512x512" href="/android-chrome-512x512.png">
<link rel="apple-touch-icon" href="/apple-touch-icon.png">

<!-- PWA App Icons -->
<link rel="apple-touch-icon" sizes="72x72" href="/static/icons/icon-72x72.png">
<link rel="apple-touch-icon" sizes="96x96" href="/static/icons/icon-96x96.png">
<link rel="apple-touch-icon" sizes="128x128" href="/static/icons/icon-128x128.png">
<link rel="apple-touch-icon" sizes="144x144" href="/static/icons/icon-144x144.png">
<link rel="apple-touch-icon" sizes="152x152" href="/static/icons/icon-152x152.png">
<link rel="apple-touch-icon" sizes="192x192" href="/static/icons/icon-192x192.png">
<link rel="apple-touch-icon" sizes="384x384" href="/static/icons/icon-384x384.png">
<link rel="apple-touch-icon" sizes="512x512" href="/static/icons/icon-512x512.png">


<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
<link href="https://cdn.jsdelivr.net/npm/quill@2.0.0/dist/quill.snow.css" rel="stylesheet">
<link rel="stylesheet" href="/css/blazemarker.css">

<style>
/* Mobile-friendly navbar improvements */
@media (max-width: 575.98px) {
  /* Full-width dropdown on mobile */
  .navbar-collapse {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    max-height: 70vh;
    overflow-y: auto;
    z-index: 1000;
  }
  
  /* Larger touch targets */
  .navbar-nav .nav-link {
    padding: 14px 20px;
    font-size: 1.1rem;
    border-bottom: 1px solid rgba(255,255,255,0.1);
  }
  
  /* Last item no border */
  .navbar-nav .nav-item:last-child .nav-link {
    border-bottom: none;
  }
  
  /* Better hover/active states on mobile */
  .navbar-nav .nav-link:active,
  .navbar-nav .nav-link:focus {
    background-color: rgba(255,255,255,0.15);
  }
  
  /* Smooth scrolling for long menus */
  .navbar-collapse {
    scroll-behavior: smooth;
  }
}
</style>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.7.0/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!--
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://getbootstrap.com/docs/5.3/assets/css/docs.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
-->
<link rel="canonical" href="https://blazemarker.com/">


{{ template "scripts" . }}

</head>

<body class="blazemarker-bg-body">

  <div class="container">
    <header class="blazemarker-header py-3">
      <h1 class="text-center"><a class="blazemarker-header-logo" href="/">Blazemarker</a></h1>

      <nav class="navbar navbar-expand-sm navbar-dark blazemarker-bg-primary sticky-top">
	<!--   <a class="navbar-brand" href="." >Blazemarker</a
	       >
	  -->

	<button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarContent">
	  <span class="navbar-toggler-icon"></span>
	</button>

	<div class="collapse navbar-collapse justify-content-sm-center" id="navbarContent">
	  <ul class="navbar-nav navbar-nav-scroll" style="--bs-scroll-height: 400px;">
            <li class="nav-item">
	      <a class="nav-link active" href="/gallery">Photos</a>
	    </li>
	    <li class="nav-item">
	      <a class="nav-link active" href="/articles">Articles</a>
	    </li>
	    <li class="nav-item">
	      <a class="nav-link active" href="/chat">
	        Chat
	        <span id="chat-unread-badge" class="badge bg-danger ms-1" style="display: none; font-size: 0.75rem; vertical-align: middle;"></span>
	      </a>
	    </li>
	    <li class="nav-item">
	      <a class="nav-link active" href="/calendar">Calendar</a>
	    </li>
	    <li class="nav-item">
	      <a class="nav-link active" href="/profile">Profile</a>
	    </li>
	  </ul>
	</div>
      </nav>
    </header>
  </div>

  {{ template "nav_body" . }}

  <!-- Online Users Widget -->
  <div id="online-users-widget" style="position: fixed; bottom: 20px; right: 20px; background: white; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); padding: 15px; min-width: 250px; max-width: 320px; z-index: 1000; display: none;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; border-bottom: 2px solid #667eea; padding-bottom: 8px;">
      <h6 style="margin: 0; color: #667eea; font-weight: 600;">ðŸ‘¥ Users</h6>
      <button id="close-online-widget" style="background: none; border: none; font-size: 20px; cursor: pointer; color: #888; line-height: 1;">&times;</button>
    </div>
    <div id="online-users-list" style="max-height: 400px; overflow-y: auto;">
      <p style="color: #888; font-size: 14px; text-align: center;">Loading...</p>
    </div>
  </div>

  <!-- Toggle button for online users -->
  <button id="toggle-online-users" style="position: fixed; bottom: 20px; right: 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 50%; width: 56px; height: 56px; font-size: 24px; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.2); z-index: 999; display: flex; align-items: center; justify-content: center;">
    ðŸ‘¥
  </button>

  <script>
    // Online users functionality
    (function() {
      const widget = document.getElementById('online-users-widget');
      const toggle = document.getElementById('toggle-online-users');
      const closeBtn = document.getElementById('close-online-widget');
      const usersList = document.getElementById('online-users-list');

      let isWidgetOpen = false;

      function toggleWidget() {
        isWidgetOpen = !isWidgetOpen;
        if (isWidgetOpen) {
          widget.style.display = 'block';
          toggle.style.display = 'none';
          fetchOnlineUsers();
        } else {
          widget.style.display = 'none';
          toggle.style.display = 'flex';
        }
      }

      function fetchOnlineUsers() {
        fetch('/api/users/online')
          .then(response => response.json())
          .then(users => {
            if (users.length === 0) {
              usersList.innerHTML = '<p style="color: #888; font-size: 14px; text-align: center;">No users found</p>';
            } else {
              // Separate online and offline users
              const onlineUsers = users.filter(u => u.is_online);
              const offlineUsers = users.filter(u => !u.is_online);
              
              let html = '';
              
              // Show online users first
              if (onlineUsers.length > 0) {
                html += '<div style="font-size: 11px; font-weight: 600; color: #10b981; margin: 8px 0 4px 0; text-transform: uppercase;">Online</div>';
                html += onlineUsers.map(user => {
                  const timeAgo = getTimeAgo(user.minutes_ago);
                  const isCurrent = user.is_current_user ? ' (you)' : '';
                  const messageBtn = !user.is_current_user ? `<a href="/chat?with=${user.username}" style="background: #667eea; color: white; border: none; padding: 4px 12px; border-radius: 4px; text-decoration: none; font-size: 11px; cursor: pointer;">Message</a>` : '';
                  return `
                    <div style="display: flex; align-items: center; padding: 8px; border-bottom: 1px solid #f0f0f0;">
                      <div style="width: 8px; height: 8px; background: #10b981; border-radius: 50%; margin-right: 10px;"></div>
                      <div style="flex: 1;">
                        <div style="font-weight: 600; color: #333; font-size: 14px;">${user.handle || user.username}${isCurrent}</div>
                        <div style="font-size: 12px; color: #10b981;">Active now</div>
                      </div>
                      ${messageBtn}
                    </div>
                  `;
                }).join('');
              }
              
              // Show offline users
              if (offlineUsers.length > 0) {
                html += '<div style="font-size: 11px; font-weight: 600; color: #888; margin: 12px 0 4px 0; text-transform: uppercase;">Offline</div>';
                html += offlineUsers.map(user => {
                  const timeAgo = getTimeAgo(user.minutes_ago);
                  const isCurrent = user.is_current_user ? ' (you)' : '';
                  const messageBtn = !user.is_current_user ? `<a href="/chat?with=${user.username}" style="background: #667eea; color: white; border: none; padding: 4px 12px; border-radius: 4px; text-decoration: none; font-size: 11px; cursor: pointer;">Message</a>` : '';
                  return `
                    <div style="display: flex; align-items: center; padding: 8px; border-bottom: 1px solid #f0f0f0;">
                      <div style="width: 8px; height: 8px; background: #cbd5e0; border-radius: 50%; margin-right: 10px;"></div>
                      <div style="flex: 1;">
                        <div style="font-weight: 600; color: #333; font-size: 14px;">${user.handle || user.username}${isCurrent}</div>
                        <div style="font-size: 12px; color: #888;">Last seen ${timeAgo}</div>
                      </div>
                      ${messageBtn}
                    </div>
                  `;
                }).join('');
              }
              
              usersList.innerHTML = html;
            }
          })
          .catch(error => {
            console.error('Failed to fetch online users:', error);
            usersList.innerHTML = '<p style="color: #dc3545; font-size: 14px; text-align: center;">Failed to load</p>';
          });
      }

      function getTimeAgo(minutesAgo) {
        if (minutesAgo < 1) return 'just now';
        if (minutesAgo < 2) return '1 minute ago';
        if (minutesAgo < 60) return minutesAgo + ' minutes ago';
        if (minutesAgo < 120) return '1 hour ago';
        if (minutesAgo < 1440) return Math.floor(minutesAgo / 60) + ' hours ago';
        if (minutesAgo < 2880) return '1 day ago';
        return Math.floor(minutesAgo / 1440) + ' days ago';
      }

      toggle.addEventListener('click', toggleWidget);
      closeBtn.addEventListener('click', toggleWidget);

      // Auto-refresh every 30 seconds when widget is open
      setInterval(() => {
        if (isWidgetOpen) {
          fetchOnlineUsers();
        }
      }, 30000);
    })();
  </script>

  <!-- PWA Service Worker Registration -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/static/service-worker.js')
          .then((registration) => {
            console.log('Service Worker registered:', registration.scope);
            
            // Check for updates periodically
            setInterval(() => {
              registration.update();
            }, 60000); // Check every minute
            
            // Auto-subscribe if permission already granted, otherwise wait for user action
            if (Notification.permission === 'granted') {
              subscribeToPushNotifications(registration);
            }
          })
          .catch((error) => {
            console.error('Service Worker registration failed:', error);
          });
      });

      // Listen for service worker updates
      navigator.serviceWorker.addEventListener('controllerchange', () => {
        console.log('New service worker activated, reloading...');
        window.location.reload();
      });
    }

    // Push notification subscription
    async function requestPushNotificationPermission(registration) {
      if (!('PushManager' in window)) {
        console.log('Push notifications not supported');
        return;
      }

      try {
        const permission = await Notification.requestPermission();
        
        if (permission === 'granted') {
          console.log('Notification permission granted');
          await subscribeToPushNotifications(registration);
        } else {
          console.log('Notification permission denied');
        }
      } catch (error) {
        console.error('Error requesting notification permission:', error);
      }
    }

    async function subscribeToPushNotifications(registration) {
      try {
        // Get VAPID public key from server
        const response = await fetch('/api/push/vapid-key');
        const data = await response.json();
        const vapidPublicKey = data.publicKey;

        // Convert VAPID key
        const convertedVapidKey = urlBase64ToUint8Array(vapidPublicKey);

        // Subscribe to push
        const subscription = await registration.pushManager.subscribe({
          userVisibleOnly: true,
          applicationServerKey: convertedVapidKey
        });

        // Send subscription to server
        await fetch('/api/push/subscribe', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            endpoint: subscription.endpoint,
            keys: {
              p256dh: arrayBufferToBase64(subscription.getKey('p256dh')),
              auth: arrayBufferToBase64(subscription.getKey('auth'))
            }
          })
        });

        console.log('Push subscription saved');
      } catch (error) {
        console.error('Error subscribing to push notifications:', error);
      }
    }

    function urlBase64ToUint8Array(base64String) {
      const padding = '='.repeat((4 - base64String.length % 4) % 4);
      const base64 = (base64String + padding)
        .replace(/\-/g, '+')
        .replace(/_/g, '/');

      const rawData = window.atob(base64);
      const outputArray = new Uint8Array(rawData.length);

      for (let i = 0; i < rawData.length; ++i) {
        outputArray[i] = rawData.charCodeAt(i);
      }
      return outputArray;
    }

    function arrayBufferToBase64(buffer) {
      const bytes = new Uint8Array(buffer);
      let binary = '';
      for (let i = 0; i < bytes.byteLength; i++) {
        binary += String.fromCharCode(bytes[i]);
      }
      return window.btoa(binary);
    }

    // Handle install prompt for PWA
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => {
      // Prevent the mini-infobar from appearing on mobile
      e.preventDefault();
      // Store the event for later use
      deferredPrompt = e;
      // Could show a custom install button here
      console.log('PWA install prompt available');
    });

    window.addEventListener('appinstalled', () => {
      console.log('PWA was installed');
      deferredPrompt = null;
    });

    // Chat unread count polling with sound notifications
    (function() {
      const badge = document.getElementById('chat-unread-badge');
      let previousUnreadCount = null; // Start as null to avoid playing on first load
      let soundEnabled = true;
      let isFirstCheck = true; // Don't play sound on first check
      let lastSoundTime = 0; // Track when we last played a sound
      const SOUND_COOLDOWN = 5000; // Don't play sounds more than once every 5 seconds
      
      // Sound notification system
      const notificationSound = new Audio('/static/sounds/notification.mp3');
      notificationSound.volume = 0.4; // 40% volume - adjust as needed
      
      // Test if sound file loads
      notificationSound.addEventListener('error', (e) => {
        console.error('Failed to load notification sound:', e);
        soundEnabled = false;
      });
      
      notificationSound.addEventListener('canplaythrough', () => {
        console.log('Notification sound loaded successfully');
      });
      
      function playNotificationSound() {
        // Check cooldown - prevent rapid-fire sounds
        const now = Date.now();
        if (now - lastSoundTime < SOUND_COOLDOWN) {
          console.log('Sound on cooldown - ignoring notification');
          return;
        }
        
        // Check if sounds are enabled
        const userPref = localStorage.getItem('soundNotifications');
        if (userPref === 'false' || !soundEnabled) {
          console.log('Sound disabled by user preference or error');
          return;
        }
        
        // Don't play sound if user is on the chat page
        if (window.location.pathname === '/chat') {
          console.log('Sound disabled - user is on chat page');
          return;
        }
        
        console.log('Playing notification sound');
        lastSoundTime = now;
        notificationSound.currentTime = 0;
        notificationSound.play()
          .then(() => console.log('Sound played successfully'))
          .catch(err => {
            console.log('Sound blocked by browser (need user interaction first):', err);
            // After first user interaction, sounds will work
          });
        
        // Also vibrate on mobile devices
        if ('vibrate' in navigator) {
          navigator.vibrate(200);
        }
      }
      
      async function updateUnreadCount() {
        try {
          const response = await fetch('/api/chat/unread-count', { 
            credentials: 'include' 
          });
          if (response.ok) {
            const data = await response.json();
            const count = data.count;
            
            // Play sound only if:
            // 1. Not the first check
            // 2. Count increased from a value >= 0 (not null)
            // 3. New count is > 0 (actually have unread messages)
            // 4. Count went UP (previous was lower)
            if (!isFirstCheck && 
                previousUnreadCount !== null && 
                count > 0 && 
                count > previousUnreadCount) {
              console.log('New message detected! Previous:', previousUnreadCount, 'Current:', count);
              playNotificationSound();
            }
            
            isFirstCheck = false;
            previousUnreadCount = count;
            
            if (count > 0) {
              badge.textContent = count > 99 ? '99+' : count;
              badge.style.display = 'inline-block';
            } else {
              badge.style.display = 'none';
            }
          }
        } catch (error) {
          console.error('Failed to fetch unread count:', error);
        }
      }
      
      // Enable sound on first user interaction
      const enableSound = () => {
        notificationSound.play().then(() => {
          notificationSound.pause();
          notificationSound.currentTime = 0;
          console.log('Sound unlocked - notifications will play');
        }).catch(() => {});
        document.removeEventListener('click', enableSound);
      };
      document.addEventListener('click', enableSound, { once: true });
      
      // Update immediately and then every 10 seconds
      updateUnreadCount();
      setInterval(updateUnreadCount, 10000);
    })();
  </script>
   
</body>

</html>
