{{define "scripts"}}
<style>
.calendar-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 0.5rem;
}

.calendar-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
    padding: 0.75rem;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 8px;
    flex-wrap: wrap;
    gap: 0.5rem;
}

.calendar-header h2 {
    font-size: 1.25rem;
}

.calendar-nav {
    display: flex;
    gap: 0.5rem;
    align-items: center;
}

.calendar-nav span {
    font-size: 1rem;
}

.calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 1px;
    background: #dee2e6;
    border: 1px solid #dee2e6;
    border-radius: 8px;
    overflow: hidden;
}

.calendar-day-header {
    background: #f8f9fa;
    padding: 0.5rem 0.25rem;
    text-align: center;
    font-weight: 600;
    color: #495057;
    font-size: 0.75rem;
}

.calendar-day {
    background: white;
    min-height: 80px;
    padding: 0.25rem;
    position: relative;
}

.calendar-day.other-month {
    background: #f8f9fa;
    color: #adb5bd;
}

.calendar-day.today {
    background: #e7f1ff;
}

.day-number {
    font-weight: 600;
    margin-bottom: 0.25rem;
    font-size: 0.75rem;
}

.event {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 0.125rem 0.25rem;
    margin-bottom: 0.125rem;
    border-radius: 3px;
    font-size: 0.625rem;
    cursor: pointer;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    line-height: 1.2;
}

.event:hover {
    opacity: 0.9;
}

.event.all-day {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
}

.upcoming-events {
    margin-top: 1.5rem;
    display: none;
}

.upcoming-events.show {
    display: block;
}

.upcoming-events-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.upcoming-events-close {
    cursor: pointer;
    font-size: 1.5rem;
    color: #6c757d;
    background: none;
    border: none;
    padding: 0;
    line-height: 1;
}

.upcoming-events-close:hover {
    color: #495057;
}

.event-card {
    border-left: 4px solid #667eea;
}

.event-card.all-day {
    border-left-color: #10b981;
}

.event-modal-content {
    max-width: 600px;
}

.calendar-day {
    cursor: pointer;
}

.calendar-day:hover {
    background: #f8f9fa !important;
}

.calendar-day.today:hover {
    background: #d0e4ff !important;
}

.upcoming-events {
    display: none;
}

.upcoming-events.show {
    display: block;
}

.upcoming-events-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
}

.upcoming-events-close {
    cursor: pointer;
    font-size: 1.5rem;
    color: #6c757d;
    background: none;
    border: none;
    padding: 0;
    line-height: 1;
}

.upcoming-events-close:hover {
    color: #495057;
}

.calendar-day {
    cursor: pointer;
}

.calendar-day:hover {
    background: #f8f9fa !important;
}

.calendar-day.today:hover {
    background: #d0e4ff !important;
}

/* Mobile optimizations */
@media (max-width: 768px) {
    .calendar-header {
        padding: 0.5rem;
    }
    
    .calendar-header h2 {
        font-size: 1rem;
        width: 100%;
        text-align: center;
    }
    
    .calendar-nav {
        width: 100%;
        justify-content: center;
    }
    
    .calendar-nav span {
        font-size: 0.875rem;
    }
    
    .calendar-nav .btn {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
    }
    
    .calendar-day-header {
        font-size: 0.625rem;
        padding: 0.375rem 0.125rem;
    }
    
    /* Hide full day names on mobile, show abbreviations */
    .calendar-day-header-full {
        display: none;
    }
    
    .calendar-day {
        min-height: 60px;
        padding: 0.125rem;
    }
    
    .day-number {
        font-size: 0.625rem;
        margin-bottom: 0.125rem;
    }
    
    .event {
        font-size: 0.5rem;
        padding: 0.125rem;
        margin-bottom: 1px;
    }
    
    /* Show only dots on very small screens */
    .event-text {
        display: inline;
    }
}

@media (max-width: 480px) {
    .calendar-day {
        min-height: 50px;
    }
    
    /* Show only dots for events on very small screens */
    .event-text {
        display: none;
    }
    
    .event::before {
        content: "‚óè";
        font-size: 0.75rem;
    }
    
    .calendar-header h2 {
        font-size: 0.875rem;
    }
}

</style>

<script>
// Event modal handling
function showEventDetails(uid) {
    const event = events.find(e => e.uid === uid);
    if (!event) return;
    
    // Unescape commas for display
    const unescape = s => s ? s.replace(/\\,/g, ',') : '';
    document.getElementById('eventTitle').textContent = unescape(event.title);
    document.getElementById('eventTime').textContent = formatEventTime(event);
    document.getElementById('eventLocation').textContent = unescape(event.location) || 'No location';
    document.getElementById('eventDescription').textContent = unescape(event.description) || 'No description';
    document.getElementById('eventUID').value = event.uid;
    
    // Check if this is a recurring event (UID format: "originalUID-20260128")
    const isRecurring = /^.+-\d{8}$/.test(event.uid);
    const deleteSeriesBtn = document.getElementById('deleteSeriesBtn');
    if (deleteSeriesBtn) {
        deleteSeriesBtn.style.display = isRecurring ? 'inline-block' : 'none';
    }
    
    new bootstrap.Modal(document.getElementById('eventModal')).show();
}

function formatEventTime(event) {
    const start = new Date(event.start_time);
    const end = new Date(event.end_time);
    
    if (event.all_day) {
        return start.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
    }
    
    return `${start.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' })} at ${start.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' })} - ${end.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' })}`;
}

function deleteEvent(deleteSeries) {
    const uid = document.getElementById('eventUID').value;
    if (!uid) return;
    
    const confirmMsg = deleteSeries ? 
        'Delete all events in this series?' : 
        'Delete this event?';
    
    if (!confirm(confirmMsg)) return;
    
    const formData = new FormData();
    formData.append('uid', uid);
    if (deleteSeries) {
        formData.append('delete_series', 'true');
    }
    
    fetch('/calendar/event/delete', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Close modal and reload page
            bootstrap.Modal.getInstance(document.getElementById('eventModal')).hide();
            window.location.reload();
        } else {
            alert('Failed to delete event');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to delete event');
    });
}

function toggleTimeInputs() {
    const allDay = document.getElementById('allDayCheck').checked;
    const startInput = document.getElementById('eventStartTime');
    const endInput = document.getElementById('eventEndTime');
    
    if (allDay) {
        // Change to date inputs
        startInput.type = 'date';
        endInput.type = 'date';
    } else {
        // Change to datetime-local inputs
        startInput.type = 'datetime-local';
        endInput.type = 'datetime-local';
    }
}

// Store events for modal
const events = {{ .EventsJSON }};

function showDayEvents(dateStr, event) {
    // Don't show if clicking on an event
    if (event.target.classList.contains('event') || event.target.closest('.event')) {
        return;
    }
    
    const date = new Date(dateStr + 'T00:00:00');
    const dayEvents = events.filter(e => {
        const eventDate = new Date(e.start_time);
        return eventDate.toDateString() === date.toDateString();
    });
    
    // Update header with selected date
    document.getElementById('selectedDate').textContent = date.toLocaleDateString('en-US', { 
        weekday: 'long', 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
    });
    
    // Show/update upcoming events section
    const upcomingSection = document.querySelector('.upcoming-events');
    const eventsContainer = upcomingSection.querySelector('.row') || upcomingSection.querySelector('.alert');
    
    if (dayEvents.length === 0) {
        upcomingSection.innerHTML = `
            <div class="upcoming-events-header">
                <h4 class="mb-0">Events for <span id="selectedDate">${date.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</span></h4>
                <button class="upcoming-events-close" onclick="hideUpcomingEvents()" title="Close">√ó</button>
            </div>
            <div class="alert alert-info">No events for this day</div>
        `;
    } else {
        let eventsHTML = '<div class="row">';
        dayEvents.forEach(evt => {
            const isAllDay = evt.all_day;
            const startTime = new Date(evt.start_time);
            const timeStr = isAllDay ? 
                startTime.toLocaleDateString('en-US', { weekday: 'long', month: 'long', day: 'numeric', year: 'numeric' }) :
                startTime.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' }) + ' at ' + 
                startTime.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
            
            eventsHTML += `
                <div class="col-md-6 mb-3">
                    <div class="card event-card ${isAllDay ? 'all-day' : ''}">
                        <div class="card-body">
                            <h5 class="card-title">${evt.title || 'Untitled Event'}</h5>
                            <p class="text-muted mb-2">
                                <i class="bi bi-calendar"></i> ${timeStr}
                            </p>
                            ${evt.location ? `<p class="text-muted mb-2"><i class="bi bi-geo-alt"></i> ${evt.location}</p>` : ''}
                            ${evt.description ? `<p class="card-text">${evt.description}</p>` : ''}
                        </div>
                    </div>
                </div>
            `;
        });
        eventsHTML += '</div>';
        
        upcomingSection.innerHTML = `
            <div class="upcoming-events-header">
                <h4 class="mb-0">Events for <span id="selectedDate">${date.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</span></h4>
                <button class="upcoming-events-close" onclick="hideUpcomingEvents()" title="Close">√ó</button>
            </div>
            ${eventsHTML}
        `;
    }
    
    upcomingSection.classList.add('show');
    upcomingSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
}

function hideUpcomingEvents() {
    document.querySelector('.upcoming-events').classList.remove('show');
}
</script>
{{end}}

{{ define "nav_body" }}
<div class="calendar-container my-4">
    <div class="calendar-header">
        <h2 class="mb-0">üìÖ Family Calendar</h2>
        <div class="calendar-nav">
            <a href="?month={{ .PrevMonth }}" class="btn btn-light btn-sm">‚Üê Previous</a>
            <span class="fs-5">{{ .MonthYear }}</span>
            <a href="?month={{ .NextMonth }}" class="btn btn-light btn-sm">Next ‚Üí</a>
            <button type="button" class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addEventModal">+ Add Event</button>
        </div>
    </div>

    <div class="calendar-grid">
        <!-- Day headers -->
        <div class="calendar-day-header"><span class="calendar-day-header-full">Sunday</span><span class="d-md-none">Sun</span></div>
        <div class="calendar-day-header"><span class="calendar-day-header-full">Monday</span><span class="d-md-none">Mon</span></div>
        <div class="calendar-day-header"><span class="calendar-day-header-full">Tuesday</span><span class="d-md-none">Tue</span></div>
        <div class="calendar-day-header"><span class="calendar-day-header-full">Wednesday</span><span class="d-md-none">Wed</span></div>
        <div class="calendar-day-header"><span class="calendar-day-header-full">Thursday</span><span class="d-md-none">Thu</span></div>
        <div class="calendar-day-header"><span class="calendar-day-header-full">Friday</span><span class="d-md-none">Fri</span></div>
        <div class="calendar-day-header"><span class="calendar-day-header-full">Saturday</span><span class="d-md-none">Sat</span></div>

        <!-- Calendar days -->
        {{ range .CalendarDays }}
        <div class="calendar-day{{ if .IsOtherMonth }} other-month{{ end }}{{ if .IsToday }} today{{ end }}" onclick="showDayEvents('{{ .Date }}', event)">
            <div class="day-number">{{ .Day }}</div>
            {{ range .Events }}
            <div class="event{{ if .AllDay }} all-day{{ end }}" onclick="event.stopPropagation(); showEventDetails('{{ .UID }}')" title="{{ .Title }}">
                <span class="event-text">{{ if .AllDay }}‚óè{{ else }}{{ .StartTimeFormatted }}{{ end }} {{ .Title }}</span>
            </div>
            {{ end }}
        </div>
        {{ end }}
    </div>

    <!-- Upcoming Events -->
    <div class="upcoming-events">
        <div class="upcoming-events-header">
            <h4 class="mb-0">Events for <span id="selectedDate"></span></h4>
            <button class="upcoming-events-close" onclick="hideUpcomingEvents()" title="Close">√ó</button>
        </div>
        {{ if eq (len .UpcomingEvents) 0 }}
        <div class="alert alert-info">No upcoming events</div>
        {{ else }}
        <div class="row">
            {{ range .UpcomingEvents }}
            <div class="col-md-6 mb-3">
                <div class="card event-card {{ if .AllDay }}all-day{{ end }}">
                    <div class="card-body">
                        <h5 class="card-title">{{ .Title }}</h5>
                        <p class="text-muted mb-2">
                            <i class="bi bi-calendar"></i>
                            {{ if .AllDay }}
                                {{ .StartTime.Format "Monday, January 2, 2006" }}
                            {{ else }}
                                {{ .StartTime.Format "Mon, Jan 2 at 3:04 PM" }}
                            {{ end }}
                        </p>
                        {{ if .Location }}
                        <p class="text-muted mb-2">
                            <i class="bi bi-geo-alt"></i> {{ .Location }}
                        </p>
                        {{ end }}
                        {{ if .Description }}
                        <p class="card-text">{{ .Description }}</p>
                        {{ end }}
                    </div>
                </div>
            </div>
            {{ end }}
        </div>
        {{ end }}
    </div>
</div>

<!-- Event Details Modal -->
<div class="modal fade" id="eventModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content event-modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                <h5 class="modal-title" id="eventTitle"></h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p><strong>When:</strong> <span id="eventTime"></span></p>
                <p><strong>Where:</strong> <span id="eventLocation"></span></p>
                <p><strong>Details:</strong></p>
                <p id="eventDescription"></p>
                <input type="hidden" id="eventUID" value="">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" onclick="deleteEvent(false)">Delete Event</button>
                <button type="button" class="btn btn-outline-danger" id="deleteSeriesBtn" onclick="deleteEvent(true)">Delete Series</button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Add Event Modal -->
<div class="modal fade" id="addEventModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                <h5 class="modal-title">Add New Event</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="/calendar/event/add">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="eventTitleInput" class="form-label">Title *</label>
                        <input type="text" class="form-control" id="eventTitleInput" name="title" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="eventDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="eventDescription" name="description" rows="3"></textarea>
                    </div>
                    
                    <div class="mb-3">
                        <label for="eventLocation" class="form-label">Location</label>
                        <input type="text" class="form-control" id="eventLocation" name="location">
                    </div>
                    
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="allDayCheck" name="all_day" value="true" onchange="toggleTimeInputs()">
                        <label class="form-check-label" for="allDayCheck">All Day Event</label>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="eventStartTime" class="form-label">Start *</label>
                            <input type="datetime-local" class="form-control" id="eventStartTime" name="start_time" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="eventEndTime" class="form-label">End</label>
                            <input type="datetime-local" class="form-control" id="eventEndTime" name="end_time">
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="recurrenceRule" class="form-label">Repeat</label>
                        <select class="form-select" id="recurrenceRule" name="recurrence_rule">
                            <option value="">Does not repeat</option>
                            <option value="DAILY:7">Daily for 7 days</option>
                            <option value="DAILY:14">Daily for 2 weeks</option>
                            <option value="WEEKLY:4">Weekly for 4 weeks</option>
                            <option value="WEEKLY:8">Weekly for 8 weeks</option>
                            <option value="MONTHLY:3">Monthly for 3 months</option>
                            <option value="MONTHLY:6">Monthly for 6 months</option>
                            <option value="MONTHLY:12">Monthly for 12 months</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Event</button>
                </div>
            </form>
        </div>
    </div>
</div>
{{end}}
