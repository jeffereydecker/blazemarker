{{define "scripts"}}
<meta name="viewport" content="width=device-width, initial-scale=1">
<script src="https://cdn.jsdelivr.net/npm/quill@2.0.0/dist/quill.js"></script>
<style>
  /* Image resizing styles */
  .ql-editor img {
    cursor: pointer;
    max-width: 100%;
    height: auto;
  }
  
  /* Default width for images without explicit width set */
  .ql-editor img:not([style*="width"]) {
    width: min(600px, 100%);
  }
  
  .ql-editor img.resizing {
    outline: 3px solid #0d6efd;
    outline-offset: 3px;
    box-shadow: 0 0 15px rgba(13, 110, 253, 0.5);
  }
  
  .image-resize-handle {
    position: fixed;
    width: 32px;
    height: 32px;
    background: #0d6efd;
    border: 4px solid white;
    border-radius: 50%;
    cursor: nwse-resize;
    z-index: 9999;
    box-shadow: 0 4px 12px rgba(0,0,0,0.4);
    transition: transform 0.15s, background 0.15s;
    pointer-events: auto;
    touch-action: none; /* Prevent scrolling on mobile while resizing */
  }
  
  .image-resize-handle:hover {
    transform: scale(1.3);
    background: #0b5ed7;
    box-shadow: 0 6px 16px rgba(0,0,0,0.5);
  }
  
  .image-resize-handle::after {
    content: 'â‡²';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: white;
    font-size: 14px;
    font-weight: bold;
  }
</style>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    const quill = new Quill('#editor', {
      theme: 'snow',
      modules: {
        toolbar: [
          [{ 'header': [1, 2, 3, false] }],
          ['bold', 'italic', 'underline'],
          ['link', 'image'],
          [{ 'list': 'ordered'}, { 'list': 'bullet' }],
          [{ 'align': [] }]
        ],
        clipboard: {
          matchVisual: false
        }
      },
      placeholder: 'Start writing...'
    });

    // Prevent Quill from handling pasted images by overriding clipboard
    const clipboard = quill.getModule('clipboard');
    clipboard.addMatcher('IMG', function(node, delta) {
      // Return empty delta to prevent default image paste
      return new (Quill.import('delta'))();
    });

    // Override the image button to use file picker instead of URL prompt
    quill.getModule('toolbar').addHandler('image', function() {
      // Create a hidden file input
      const input = document.createElement('input');
      input.setAttribute('type', 'file');
      input.setAttribute('accept', 'image/*');
      input.style.display = 'none';
      document.body.appendChild(input);
      
      input.addEventListener('change', function() {
        const file = input.files[0];
        if (file) {
          // Get cursor position for inserting image after upload
          const range = quill.getSelection(true);
          
          // Upload image to server
          const formData = new FormData();
          formData.append('image', file);
          
          fetch('/api/upload-article-image', {
            method: 'POST',
            body: formData,
            credentials: 'same-origin'
          })
          .then(response => {
            if (!response.ok) {
              throw new Error('Upload failed');
            }
            return response.json();
          })
          .then(data => {
            // Insert uploaded image at cursor position
            quill.insertEmbed(range.index, 'image', data.url);
            quill.setSelection(range.index + 1);
            
            // Find the newly inserted image and set its size when it loads
            const imgs = quill.root.querySelectorAll('img');
            for (let img of imgs) {
              if (img.src.includes(data.url)) {
                // Set size after image loads to ensure it's in the DOM
                const setSizeWhenReady = () => {
                  img.setAttribute('style', 'width: 600px; max-width: 100%; height: auto;');
                };
                
                if (img.complete) {
                  // Image already loaded
                  setSizeWhenReady();
                } else {
                  // Wait for image to load
                  img.onload = setSizeWhenReady;
                }
                break;
              }
            }
          })
          .catch(error => {
            console.error('Image upload failed:', error);
            alert('Failed to upload image. Please try again.');
          });
        }
        document.body.removeChild(input);
      });
      
      input.click();
    });

    // Handle pasted images - use capture phase to intercept before Quill
    quill.root.addEventListener('paste', function(e) {
      const clipboardData = e.clipboardData || window.clipboardData;
      if (!clipboardData) return;
      
      const items = clipboardData.items;
      let hasImage = false;
      for (let i = 0; i < items.length; i++) {
        if (items[i].type.indexOf('image') !== -1) {
          hasImage = true;
          e.preventDefault();
          e.stopPropagation();
          
          const file = items[i].getAsFile();
          const range = quill.getSelection(true);
          
          // Upload image to server
          const formData = new FormData();
          formData.append('image', file);
          
          fetch('/api/upload-article-image', {
            method: 'POST',
            body: formData,
            credentials: 'same-origin'
          })
          .then(response => {
            if (!response.ok) {
              throw new Error('Upload failed');
            }
            return response.json();
          })
          .then(data => {
            // Insert uploaded image at cursor position
            quill.insertEmbed(range.index, 'image', data.url);
            quill.setSelection(range.index + 1);
            
            // Find the newly inserted image and set its size when it loads
            const imgs = quill.root.querySelectorAll('img');
            for (let img of imgs) {
              if (img.src.includes(data.url)) {
                // Set size after image loads to ensure it's in the DOM
                const setSizeWhenReady = () => {
                  img.setAttribute('style', 'width: 600px; max-width: 100%; height: auto;');
                };
                
                if (img.complete) {
                  // Image already loaded
                  setSizeWhenReady();
                } else {
                  // Wait for image to load
                  img.onload = setSizeWhenReady;
                }
                break;
              }
            }
          })
          .catch(error => {
            console.error('Image upload failed:', error);
            alert('Failed to upload image. Please try again.');
          });
          
          break;
        }
      }
      
      // If we found an image, stop all default behavior
      if (hasImage) {
        e.stopImmediatePropagation();
        return false;
      }
    }, true); // Use capture phase

    // Image resize functionality
    let resizingImage = null;
    let startX, startY, startWidth, startHeight;
    let resizeHandle = null;

    // Add click handler to images for resizing
    quill.root.addEventListener('click', function(e) {
      if (e.target.tagName === 'IMG') {
        e.preventDefault();
        
        // Remove previous resize handles
        document.querySelectorAll('.image-resize-handle').forEach(h => h.remove());
        
        // Remove resizing class from all images
        quill.root.querySelectorAll('img').forEach(img => {
          img.classList.remove('resizing');
        });
        
        // Add resizing class to clicked image
        e.target.classList.add('resizing');
        resizingImage = e.target;
        
        // Create resize handle
        resizeHandle = document.createElement('div');
        resizeHandle.className = 'image-resize-handle';
        resizeHandle.title = 'Drag to resize image';
        
        // Position handle at bottom-right of image
        const rect = resizingImage.getBoundingClientRect();
        resizeHandle.style.left = (rect.right - 16) + 'px';
        resizeHandle.style.top = (rect.bottom - 16) + 'px';
        
        document.body.appendChild(resizeHandle);
        
        // Add mouse and touch handlers to resize handle
        resizeHandle.addEventListener('mousedown', startResize);
        resizeHandle.addEventListener('touchstart', startResize);
      } else if (!e.target.classList.contains('image-resize-handle')) {
        // Clicked outside image, remove handles
        document.querySelectorAll('.image-resize-handle').forEach(h => h.remove());
        resizeHandle = null;
        
        quill.root.querySelectorAll('img').forEach(img => {
          img.classList.remove('resizing');
        });
        resizingImage = null;
      }
    });

    function startResize(e) {
      e.preventDefault();
      
      // Get coordinates from either mouse or touch event
      const clientX = e.touches ? e.touches[0].clientX : e.clientX;
      const clientY = e.touches ? e.touches[0].clientY : e.clientY;
      
      startX = clientX;
      startY = clientY;
      startWidth = resizingImage.offsetWidth;
      startHeight = resizingImage.offsetHeight;
      
      document.addEventListener('mousemove', doResize);
      document.addEventListener('mouseup', stopResize);
      document.addEventListener('touchmove', doResize);
      document.addEventListener('touchend', stopResize);
    }

    function doResize(e) {
      if (!resizingImage) return;
      e.preventDefault();
      
      // Get coordinates from either mouse or touch event
      const clientX = e.touches ? e.touches[0].clientX : e.clientX;
      const clientY = e.touches ? e.touches[0].clientY : e.clientY;
      
      const deltaX = clientX - startX;
      const deltaY = clientY - startY;
      
      // Use the larger delta to maintain aspect ratio
      const delta = Math.abs(deltaX) > Math.abs(deltaY) ? deltaX : deltaY;
      
      let newWidth = startWidth + delta;
      
      // Set minimum and maximum width
      newWidth = Math.max(100, Math.min(newWidth, quill.root.offsetWidth - 20));
      
      resizingImage.style.width = newWidth + 'px';
      resizingImage.style.height = 'auto';
      
      // Update resize handle position
      const rect = resizingImage.getBoundingClientRect();
      resizeHandle.style.left = (rect.right - 16) + 'px';
      resizeHandle.style.top = (rect.bottom - 16) + 'px';
    }

    function stopResize() {
      document.removeEventListener('mousemove', doResize);
      document.removeEventListener('mouseup', stopResize);
      document.removeEventListener('touchmove', doResize);
      document.removeEventListener('touchend', stopResize);
    }

    // Set initial content if editing existing article
    const contentInput = document.querySelector('#content');
    const existingContent = document.querySelector('#existingContent');
    if (existingContent && existingContent.innerHTML.trim()) {
      quill.root.innerHTML = existingContent.innerHTML;
    }

    // Handle form submission - copy Quill content to hidden input
    const form = document.querySelector('form');
    form.addEventListener('submit', function(e) {
      contentInput.value = quill.root.innerHTML;
    });
  });
</script>

{{end}}

{{ define "nav_body" }}

<div class="container text-center my-5">
  <header>
    <h2>{{ if .Article.ID }}Edit Article{{ else }}New Article{{ end }}</h2>
  </header>
</div>

<div class="container">
  <div class="row justify-content-center">
    <div class="col-lg-8">
      <div class="card shadow-sm">
        <div class="card-body">
          <form method="post" action="/article">
            {{ if .Article.ID }}
            <input type="hidden" name="id" value="{{ .Article.ID }}">
            {{ end }}

            <div class="mb-4">
              <input 
                type="text" 
                name="title" 
                class="form-control form-control-lg" 
                placeholder="Enter the title"
                value="{{ .Article.Title }}"
                required 
                autofocus>
            </div>

            <div class="mb-4">
              <label for="tags" class="form-label">Tags (optional)</label>
              <input 
                type="text" 
                name="tags" 
                id="tags"
                class="form-control" 
                placeholder="e.g., family, vacation, beach"
                value="{{ .Article.Tags }}"
                list="available-tags">
              <datalist id="available-tags">
                {{ range .AvailableTags }}
                <option value="{{ . }}">
                {{ end }}
              </datalist>
              <small class="form-text text-muted">Separate tags with commas. Don't include the # symbol.</small>
            </div>

            <div class="mb-4">
              <div id="editor"></div>
              <input type="hidden" id="content" name="content">
              <!-- Hidden div to store existing content without HTML escaping -->
              <div id="existingContent" style="display: none;">{{ .Article.Content }}</div>
            </div>

            {{ if .Profile.IsAdmin }}
            <div class="mb-4 form-check">
              <input 
                class="form-check-input" 
                type="checkbox" 
                name="is_now" 
                id="is_now" 
                value="on"
                {{ if .Article.IsNow }}checked{{ end }}>
              <label class="form-check-label" for="is_now">
                Mark as "Now" article
              </label>
            </div>
            
            <div class="mb-4 form-check">
              <input 
                class="form-check-input" 
                type="checkbox" 
                name="is_index" 
                id="is_index" 
                value="on"
                {{ if .Article.IsIndex }}checked{{ end }}>
              <label class="form-check-label" for="is_index">
                Mark as "Index" article (shown on home page)
              </label>
            </div>
            {{ end }}

            <div class="mb-4 form-check">
              <input 
                class="form-check-input" 
                type="checkbox" 
                name="is_private" 
                id="is_private" 
                value="on"
                {{ if .Article.IsPrivate }}checked{{ end }}>
              <label class="form-check-label" for="is_private">
                ðŸ”’ Private (only visible to you)
              </label>
            </div>

            <div class="d-flex gap-2">
              <button type="submit" class="btn btn-primary btn-lg flex-grow-1">
                {{ if .Article.ID }}Update Article{{ else }}Create Article{{ end }}
              </button>
              {{ if .Article.ID }}
              <a href="/articles" class="btn btn-secondary btn-lg">Cancel</a>
              {{ end }}
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

{{ end }}