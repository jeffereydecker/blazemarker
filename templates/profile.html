{{define "scripts"}}{{end}}

{{ define "nav_body" }}

<div class="container mt-4">
  <div class="row">
    <div class="col-md-8 offset-md-2">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h3>User Profile</h3>
          {{ if .IsAdmin }}
          <span class="badge bg-danger">Admin</span>
          {{ end }}
        </div>
        <div class="card-body">
          <form method="POST" action="/profile" enctype="multipart/form-data">
            
            <!-- Avatar Section -->
            <div class="mb-4 text-center">
              {{ if .AvatarPath }}
                <img src="{{ .AvatarPath }}" alt="Avatar" class="rounded-circle mb-3" style="width: 150px; height: 150px; object-fit: cover;">
              {{ else }}
                <div class="rounded-circle bg-secondary d-inline-flex align-items-center justify-content-center mb-3" style="width: 150px; height: 150px;">
                  <span class="text-white fs-1">{{ slice .Username 0 1 | upper }}</span>
                </div>
              {{ end }}
              <div>
                <label for="avatar" class="form-label">Upload New Avatar</label>
                <input type="file" class="form-control" id="avatar" name="avatar" accept="image/*">
                <small class="form-text text-muted">Recommended: Square image, at least 300x300 pixels</small>
              </div>
            </div>

            <!-- Username (read-only) -->
            <div class="mb-3">
              <label for="username" class="form-label">Username</label>
              <input type="text" class="form-control" id="username" name="username" value="{{ .Username }}" readonly>
            </div>

            <!-- Handle -->
            <div class="mb-3">
              <label for="handle" class="form-label">Handle</label>
              <input type="text" class="form-control" id="handle" name="handle" value="{{ .Handle }}" placeholder="Your display name" required>
              <small class="form-text text-muted">This will be used to identify you on articles</small>
            </div>

            <!-- Email -->
            <div class="mb-3">
              <label for="email" class="form-label">Email Address</label>
              <input type="email" class="form-control" id="email" name="email" value="{{ .Email }}" placeholder="your.email@example.com">
              <small class="form-text text-muted">Used for notifications</small>
            </div>

            <!-- Email Notifications -->
            <div class="mb-3">
              <div class="form-check">
                <input type="checkbox" class="form-check-input" id="notify_on_new_articles" name="notify_on_new_articles" {{ if .NotifyOnNewArticles }}checked{{ end }}>
                <label class="form-check-label" for="notify_on_new_articles">
                  üìß Send me email notifications when new articles are published
                </label>
              </div>
              <small class="form-text text-muted">You'll receive an email when someone publishes a new public article (requires email address above)</small>
            </div>

            <!-- Push Notifications -->
            <div class="mb-3">
              <div class="form-check">
                <input type="checkbox" class="form-check-input" id="notify_on_new_messages" name="notify_on_new_messages" {{ if .NotifyOnNewMessages }}checked{{ end }}>
                <label class="form-check-label" for="notify_on_new_messages">
                  üîî Send me push notifications for new chat messages
                </label>
              </div>
              <small class="form-text text-muted">You'll receive real-time notifications when someone sends you a message (requires browser permission)</small>
            </div>

            <!-- Phone -->
            <div class="mb-3">
              <label for="phone" class="form-label">Phone Number</label>
              <input type="tel" class="form-control" id="phone" name="phone" value="{{ .Phone }}" placeholder="+1 (555) 123-4567">
              <small class="form-text text-muted">Used for SMS notifications</small>
            </div>

            <div class="d-grid gap-2">
              <button type="submit" class="btn btn-primary">Save Profile</button>
              <a href="/changepassword" class="btn btn-warning">Change Password</a>
              <a href="/" class="btn btn-secondary">Cancel</a>
            </div>
          </form>
          
          <!-- MUD Client Controls (only for jdecker) -->
          {{ if eq .Username "jdecker" }}
          <hr class="my-4">
          <div class="mud-controls">
            <h5 class="mb-3">MUD Client Control</h5>
            <div class="d-flex align-items-center gap-2 mb-3">
              <span class="badge" id="mudStatus">Checking...</span>
              <span id="mudStatusText" class="text-muted small"></span>
            </div>
            <div class="d-grid gap-2">
              <button class="btn btn-success" id="startMudBtn" onclick="startMud()">
                üéÆ Start MUD Client
              </button>
              <button class="btn btn-danger" id="stopMudBtn" onclick="stopMud()">
                ‚èπÔ∏è Stop MUD Client
              </button>
            </div>
          </div>
          {{ end }}
          
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// MUD Client controls
async function checkMudStatus() {
  try {
    const response = await fetch('/api/mud/status', { credentials: 'include' });
    const data = await response.json();
    
    const statusBadge = document.getElementById('mudStatus');
    const statusText = document.getElementById('mudStatusText');
    const startBtn = document.getElementById('startMudBtn');
    const stopBtn = document.getElementById('stopMudBtn');
    
    if (data.running) {
      statusBadge.className = 'badge bg-success';
      statusBadge.textContent = 'Running';
      statusText.textContent = 'Connected to funklord.com';
      startBtn.disabled = true;
      stopBtn.disabled = false;
    } else {
      statusBadge.className = 'badge bg-secondary';
      statusBadge.textContent = 'Stopped';
      statusText.textContent = 'Not connected';
      startBtn.disabled = false;
      stopBtn.disabled = true;
    }
  } catch (error) {
    console.error('Error checking MUD status:', error);
  }
}

async function startMud() {
  try {
    const response = await fetch('/api/mud/start', {
      method: 'POST',
      credentials: 'include'
    });
    
    if (response.ok) {
      alert('MUD client started successfully!');
      checkMudStatus();
    } else {
      const text = await response.text();
      alert('Failed to start MUD client: ' + text);
    }
  } catch (error) {
    console.error('Error starting MUD:', error);
    alert('Error starting MUD client');
  }
}

async function stopMud() {
  try {
    const response = await fetch('/api/mud/stop', {
      method: 'POST',
      credentials: 'include'
    });
    
    if (response.ok) {
      alert('MUD client stopped successfully!');
      checkMudStatus();
    } else {
      const text = await response.text();
      alert('Failed to stop MUD client: ' + text);
    }
  } catch (error) {
    console.error('Error stopping MUD:', error);
    alert('Error stopping MUD client');
  }
}

// Check MUD status on page load and periodically
if (document.querySelector('.mud-controls')) {
  checkMudStatus();
  setInterval(checkMudStatus, 5000); // Check every 5 seconds
}

// Request notification permission when user enables push notifications
document.getElementById('notify_on_new_messages')?.addEventListener('change', async function(e) {
  if (e.target.checked && 'serviceWorker' in navigator && 'Notification' in window) {
    if (Notification.permission === 'default') {
      const permission = await Notification.requestPermission();
      if (permission !== 'granted') {
        e.target.checked = false;
        alert('Push notifications require browser permission. Please enable notifications in your browser settings.');
      } else {
        // Subscribe to push notifications
        const registration = await navigator.serviceWorker.ready;
        if (typeof subscribeToPushNotifications === 'function') {
          await subscribeToPushNotifications(registration);
        }
      }
    } else if (Notification.permission === 'denied') {
      e.target.checked = false;
      alert('Push notifications are blocked. Please enable them in your browser settings.');
    }
  }
});
</script>

{{ end }}
